services:
  development:
    profiles: ['performance']
    build: .
    container_name: trade-demo-frontend-performance-tests
    volumes:
      - ./reports:/opt/perftest/reports
    depends_on:
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    env_file:
      - 'compose/aws.env'
    environment:
      S3_ENDPOINT: 'http://localstack:4566'
      RESULTS_OUTPUT_S3_PATH: 's3://test-results'
      ENVIRONMENT: local
      SERVICE_ENDPOINT: localhost
      SERVICE_PORT: 3000
      SERVICE_URL_SCHEME: http
    networks:
      - performance-tests

  localstack:
    image: localstack/localstack:4.3.0
    container_name: perf-localstack
    profiles: ['infra','services','performance']
    ports:
      - '4566:4566' # LocalStack Gateway
      - '4510-4559:4510-4559' # external services port range
    restart: always
    env_file:
      - 'compose/aws.env'
    environment:
      DEBUG: ${DEBUG:-1}
      LS_LOG: WARN # Localstack DEBUG Level
      SERVICES: s3,sqs,sns,cloudwatch,sts
      LOCALSTACK_HOST: 127.0.0.1
    volumes:
      - '${TMPDIR:-/tmp}/localstack:/var/lib/localstack'
      - ./compose/localstack:/etc/localstack/init/ready.d
    healthcheck:
      test: [ "CMD", "stat", "/tmp/READY" ]
      interval: 3s
      start_period: 5s
      retries: 3
    networks:
      - performance-tests

  redis:
    image: redis:7.2.3-alpine3.18
    container_name: perf-redis
    profiles: ['infra','services','performance']
    ports:
      - '6379:6379'
    restart: always
    healthcheck:
      test: [ 'CMD', 'redis-cli', 'ping' ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - performance-tests

  trade-demo-frontend:
    build:
      context: ../trade-demo-frontend
      target: development
    container_name: perf-trade-demo-frontend
    profiles: ['services', 'performance']
    ports:
      - '3000:3000'
      - '9229:9229'
    depends_on:
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
      defra-id-stub:
        condition: service_healthy
      trade-demo-backend:
        condition: service_healthy
      trade-commodity-codes:
        condition: service_healthy
    env_file:
      - 'compose/aws.env'
    environment:
      PORT: 3000
      NODE_ENV: development

      # Redis - use service name
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SESSION_CACHE_ENGINE: redis
      USE_SINGLE_INSTANCE_CACHE: true
      REDIS_TLS: false

      # DEFRA ID - use service name instead of localhost
      DEFRA_ID_OIDC_CONFIGURATION_URL: http://defra-id-stub:3200/cdp-defra-id-stub/.well-known/openid-configuration
      DEFRA_ID_CLIENT_ID: test-client
      DEFRA_ID_CLIENT_SECRET: test-secret
      DEFRA_ID_SERVICE_ID: test-service
      DEFRA_ID_STUB_URL: http://defra-id-stub:3200

      # Backend APIs - use service names
      BACKEND_API_URL: http://trade-demo-backend:8085
      COMMODITY_CODE_API_URL: http://trade-commodity-codes:8086

      # OAuth callback URL - uses localhost because browser redirects
      APP_BASE_URL: http://localhost:3000

      # Logging
      LOG_LEVEL: debug
      LOG_FORMAT: pino-pretty

      # Security (relaxed for local)
      ENABLE_SECURE_CONTEXT: false
      ENABLE_METRICS: false
    networks:
      - performance-tests
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgres:
    image: postgres:16
    container_name: perf-postgres
    profiles: ['infra', 'services', 'performance']
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - '5432:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./compose/init-postgres.sh:/docker-entrypoint-initdb.d/init-postgres.sh
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres']
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - performance-tests

  mongodb:
    image: mongo:7.0
    container_name: perf-mongodb
    profiles: ['infra', 'services', 'performance']
    restart: always
    ports:
      - '27017:27017'
    volumes:
      - mongodb-data:/data/db
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', 'db.adminCommand("ping")']
      interval: 5s
      start_period: 10s
      retries: 3
    networks:
      - performance-tests

  defra-id-stub:
    image: defradigital/cdp-defra-id-stub:latest
    container_name: perf-defra-id-stub
    profiles: ['infra', 'services', 'performance']
    ports:
      - '3200:3200'
    depends_on:
      redis:
        condition: service_healthy
    environment:
      PORT: 3200
      DEFRA_ID_STUB_URL: http://defra-id-stub:3200
      APP_BASE_URL: http://defra-id-stub:3200
      REDIRECT_URLS: http://trade-demo-frontend:3000/auth/callback,http://localhost:3000/auth/callback
      OIDC_CLIENT_ID: ${DEFRA_ID_CLIENT_ID:-test-client}
      OIDC_CLIENT_SECRET: ${DEFRA_ID_CLIENT_SECRET:-test-secret}
      SERVICE_ID: ${DEFRA_ID_SERVICE_ID:-test-service}
      USE_SINGLE_INSTANCE_CACHE: true
      SESSION_CACHE_ENGINE: memory
    networks:
      - performance-tests
    healthcheck:
      test:
        [
          'CMD',
          'curl',
          '-f',
          'http://localhost:3200/cdp-defra-id-stub/.well-known/openid-configuration'
        ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  ################################################################################
  # Application Services
  ################################################################################

  # Liquibase schema migrations for trade-commodity-codes

  trade-commodity-codes-liquibase-schema:
    image: liquibase/liquibase:4.32.0
    container_name: perf-trade-commodity-codes-liquibase-schema
    profiles: ['services', 'performance']
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../trade-commodity-codes/changelog:/liquibase/changelog
    command: >
      --driver=org.postgresql.Driver
      --changelog-file=changelog/db.changelog.xml
      --url=jdbc:postgresql://postgres:5432/trade-commodity-codes
      --username=postgres
      --password=postgres
      update
    networks:
      - performance-tests

  trade-commodity-codes-liquibase-data:
    image: liquibase/liquibase:4.32.0
    container_name: perf-trade-commodity-codes-liquibase-data
    profiles: ["services", 'performance']
    depends_on:
      trade-commodity-codes-liquibase-schema:
        condition: service_completed_successfully
    volumes:
      - ../trade-commodity-codes/data:/liquibase/data
      - ../trade-commodity-codes/data/csv:/liquibase/data/csv
    command: >
      --driver=org.postgresql.Driver
      --changelog-file=data/db.changelog.xml
      --url=jdbc:postgresql://postgres:5432/trade-commodity-codes
      --username=postgres
      --password=postgres
      update
    networks:
      - performance-tests

  trade-commodity-codes:
    build:
      context: ../trade-commodity-codes
      target: development
    container_name: perf-trade-commodity-codes
    profiles: ['services', 'performance']
    ports:
      - '8086:8086'
      - '5006:5005'
    depends_on:
      localstack:
        condition: service_healthy
      postgres:
        condition: service_healthy
      trade-commodity-codes-liquibase-schema:
        condition: service_completed_successfully
      trade-commodity-codes-liquibase-data:
        condition: service_completed_successfully
    volumes:
      - ../trade-commodity-codes/changelog:/app/changelog
    env_file:
      - './compose/aws.env'
    environment:
      PORT: 8086
      SERVICE_VERSION: 0.0.0-local
      ENVIRONMENT: local

      # PostgreSQL
      POSTGRES_WRITE_HOSTNAME: postgres
      POSTGRES_DATABASE: trade-commodity-codes

      # AWS (via LocalStack)
      LOCALSTACK_ENDPOINT: http://localstack:4566
      AWS_REGION: eu-west-2
      AWS_EMF_ENVIRONMENT: Local
      AWS_EMF_NAMESPACE: trade-commodity-codes
      AWS_EMF_SERVICE_TYPE: SpringBootApp
      AWS_EMF_WRITE_TO_STDOUT: true

      # Logging
      LOG_LEVEL: DEBUG

      # Metrics
      ENABLE_METRICS: true

      # Spring profile
      SPRING_PROFILES_ACTIVE: local

      # Liquibase
      LIQUIBASE_CHANGELOG_PATH: changelog/db.changelog.xml
    networks:
      - performance-tests
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8086/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  trade-demo-backend:
    build:
      context: ../trade-demo-backend
      target: development
    container_name: perf-trade-demo-backend
    profiles: ['services', 'performance']
    ports:
      - '8085:8085'
      - '5005:5005'
    depends_on:
      localstack:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    env_file:
      - './compose/aws.env'
    environment:
      PORT: 8085
      SERVICE_VERSION: 0.0.0-local
      ENVIRONMENT: local

      # MongoDB
      MONGO_URI: mongodb://mongodb:27017
      MONGO_DATABASE: trade-demo-backend

      # AWS (via LocalStack)
      LOCALSTACK_ENDPOINT: http://localstack:4566
      AWS_REGION: eu-west-2

      # Logging
      LOG_LEVEL: DEBUG

      # Metrics
      ENABLE_METRICS: true

      # Spring profile
      SPRING_PROFILES_ACTIVE: local
    networks:
      - performance-tests
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8085/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  localstack-data:
  postgres-data:
  mongodb-data:

networks:
  performance-tests:
    driver: bridge
    name: performance-tests


